close all
clear all
clc
addpath("/Users/tobiasacchetto/Documents/GitHub/Numerical_Analysis_II/Function");

A= [
    -3.933 0.107 0.126 0 -9.99 0 -45.83 -7.64;
    0 -0.987 0 -22.95 9 -28.37 0 0;
    0.002 0 -0.235 0 5.67 0 -0.921 -6.51;
    0 1.0 0 -1.0 0 -0.168 0 0;
    0 0 -1.0 0 -0.196 0 -0.0071 0;
    ];

%x1=velocita' di rollio
%x2=velocita' di beccheggio
%x3=velocita' di imbardata
%x4=angolo di attacco
%x5=angolo di derapata
%x6=controlli di deviazione
%x7=controlli di alettone
%x8=controlli di timone
A1=A(1:5,1:5);
A2=A(1:5,6:8);

% Definisci le variabili simboliche per w
syms w1 w2 w3 w4 w5

% Definisci il vettore psi in termini delle variabili simboliche
psi = [
    -0.727*w2*w3 + 8.39*w3*w4 - 684.4*w4*w5 + 63.5*w4*w2;
    0.949*w1*w3 + 0.173*w1*w5;
   -0.716*w1*w2 - 1.578*w1*w4 + 1.132*w4*w2;
   -w1*w5;
    w1*w4
];
% psi = @(w) [ -0.727*w(2)*w(3) + 8.39*w(3)*w(4) - 684.4*w(4)*w(5) + 63.5*w(4)*w(2);
%              0.949*w(1)*w(3) + 0.173*w(1)*w(5);
%             -0.716*w(1)*w(2) - 1.578*w(1)*w(4) + 1.132*w(4)*w(2);
%             -w(1)*w(5);
%              w(1)*w(4) ];
J_psi = jacobian(psi, [w1, w2, w3, w4, w5]); %usando syms
% J_psi = @(w) [
%     [0, -0.727*w(3) + 8.39*w(4), -0.727*w(2), 8.39*w(3) - 684.4*w(5), -684.4*w(4)];
%     [0.949*w(3), 0, 0.949*w(1), 0.173*w(5), 0.173*w(1)];
%     [-0.716*w(2), -0.716*w(1), 0, -1.578*w(1) + 1.132*w(2), -1.578*w(4)];
%     [-w(5), 0, 0, 0, -w(1)];
%     [w(4), 0, 0, w(1), 0]
% ];
% Example control inputs (replace with actual values)
u = [1; 0.2; 0.5]; % [x6; x7; x8]


f=-inv(A1)*(A2*u+psi);

%J_f = @(w) -inv(A1) * (A2 * 0 + J_psi(w));

x0=zeros(5,1);

maxit=100;
tolx=1e-8;tolf=1e-8;
J_f = jacobian(f, [w1, w2, w3, w4, w5]);
J_f =
 
[           (2489267707638267959*w3)/2305843009213693952000 - (1431947993780297219*w2)/4503599627370496000 - (6962920184930646679*w4)/9007199254740992000 + (60652620867986998943*w5)/2305843009213693952000,           (18760269243188807747*w4)/1125899906842624000 - (3332850062026905149*w3)/18014398509481984000 - (1431947993780297219*w1)/4503599627370496000,             (2489267707638267959*w1)/2305843009213693952000 - (3332850062026905149*w2)/18014398509481984000 + (3846301515874241293*w4)/1801439850948198400,                 (18760269243188807747*w2)/1125899906842624000 - (6962920184930646679*w1)/9007199254740992000 + (3846301515874241293*w3)/1801439850948198400 - (7843887835114215557*w5)/45035996273704960,          (60652620867986998943*w1)/2305843009213693952000 - (7843887835114215557*w4)/45035996273704960]
[            (424584708701874307*w2)/9007199254740992000 + (5713532337449480739*w3)/144115188075855872000 + (8600501367198548373*w4)/72057594037927936000 + (139213918059899185003*w5)/144115188075855872000,  (424584708701874307*w1)/9007199254740992000 + (3591796527292404497*w3)/147573952589676412928000 - (2827956777635862302469*w4)/36893488147419103232000,      (5713532337449480739*w1)/144115188075855872000 + (3591796527292404497*w2)/147573952589676412928000 - (4145140696558909729*w4)/14757395258967641292800,  (8600501367198548373*w1)/72057594037927936000 - (2827956777635862302469*w2)/36893488147419103232000 - (4145140696558909729*w3)/14757395258967641292800 + (8453320300133843321*w5)/368934881474191032320,      (139213918059899185003*w1)/144115188075855872000 + (8453320300133843321*w4)/368934881474191032320]
[(5593850152658506739*w3)/75557863725914323419136000 - (885334976778029321*w2)/36028797018963968000 + (67574198544547954289*w4)/72057594037927936000 + (136297784067357875003*w5)/75557863725914323419136000, (1474198785745427608833*w4)/36893488147419103232000 - (1872384373429384861*w3)/147573952589676412928000 - (885334976778029321*w1)/36028797018963968000, (5593850152658506739*w1)/75557863725914323419136000 - (1872384373429384861*w2)/147573952589676412928000 + (2160839737699111277*w4)/14757395258967641292800, (67574198544547954289*w1)/72057594037927936000 + (1474198785745427608833*w2)/36893488147419103232000 + (2160839737699111277*w3)/14757395258967641292800 - (4406670788084838373*w5)/368934881474191032320, (136297784067357875003*w1)/75557863725914323419136000 - (4406670788084838373*w4)/368934881474191032320]
[              (424584708701874307*w2)/9007199254740992000 + (5713532337449480739*w3)/144115188075855872000 + (8600501367198548373*w4)/72057594037927936000 - (4901270015956685997*w5)/144115188075855872000,  (424584708701874307*w1)/9007199254740992000 + (3591796527292404497*w3)/147573952589676412928000 - (2827956777635862302469*w4)/36893488147419103232000,      (5713532337449480739*w1)/144115188075855872000 + (3591796527292404497*w2)/147573952589676412928000 - (4145140696558909729*w4)/14757395258967641292800,  (8600501367198548373*w1)/72057594037927936000 - (2827956777635862302469*w2)/36893488147419103232000 - (4145140696558909729*w3)/14757395258967641292800 + (8453320300133843321*w5)/368934881474191032320,        (8453320300133843321*w4)/368934881474191032320 - (4901270015956685997*w1)/144115188075855872000]
[      (282313449227687929*w2)/2251799813685248000 - (3567506474909761917*w3)/9444732965739290427392000 + (1429654175184942039*w4)/4503599627370496000 - (86924607185814969909*w5)/9444732965739290427392000,     (282313449227687929*w1)/2251799813685248000 + (1194122687136087243*w3)/18446744073709551616000 - (940177797031522733959*w4)/4611686018427387904000,    (1194122687136087243*w2)/18446744073709551616000 - (3567506474909761917*w1)/9444732965739290427392000 - (1378086567410147451*w4)/1844674407370955161600,       (1429654175184942039*w1)/4503599627370496000 - (940177797031522733959*w2)/4611686018427387904000 - (1378086567410147451*w3)/1844674407370955161600 + (2810376778115330499*w5)/46116860184273879040,    (2810376778115330499*w4)/46116860184273879040 - (86924607185814969909*w1)/9444732965739290427392000]
 
[x,it,iterati]=sis_newton(f,J_f,x0,tolx,tolf,maxit);



% Output the result
disp('Computed state vector w:');
fprintf('n. di iterazioni=%d \nx=[%g %g %g %g %g]\n',it,x);
for i=1:it+1
    fu(i)=norm(iterati{i}-f(iterati{i}));
end
semilogy(1:length(iterati), fu,'r*-'); %semilogy Ã¨ un grafico con la scala logaritmica
title('residuo in norma euclidea versus iterazioni');